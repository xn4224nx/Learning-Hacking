#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <fcntl.h>
#include <sys/stat.h>

#include "hacking.h"


int main(int argc, char **argv)
{
	int file_des, userid;
	char *buffer, *datafile, *userid_buf;
	
	/* Allocate memory for the strings. */
	buffer = (char *) errorchecked_malloc(100);
	datafile = (char *) errorchecked_malloc(20);
	userid_buf = (char *) errorchecked_malloc(20);
	
	/* Add in filepath of the file folder. */
	strcpy(datafile, "/var/notes");
	
	/* Check that enough arguments have been given. */
	if (argc < 2) 
	    usage(argv[0], datafile);
	
	/* Copy the argument into memory. */
	strcpy(buffer, argv[1]);
	printf("[DEBUG] buffer @ %p: `%s`\n", buffer, buffer);
	printf("[DEBUG] buffer @ %p: `%s`\n", datafile, datafile);
	strncat(buffer, "\n", 1);
	
	/* Get the real user ID as a string. */
	userid = getuid();
	sprintf(userid_buf, "%d", userid);
	
	/* Open the file. */
	file_des = open(datafile, O_WRONLY|O_CREAT|O_APPEND, S_IRUSR|S_IWUSR);
	
	if (file_des == -1)
	    fatal("In main() trying to open a file.");
	
	printf("[DEBUG] file descriptor is %d.\n", file_des);
	
	/* Write the user id to file before the note data. */
	if (write(file_des, userid_buf, strlen(userid_buf)) == -1)
	    fatal("In main() writing to file.");
	write(file_des, "\n", 1);
	
	/* Write data to the file. */
	if (write(file_des, buffer, strlen(buffer)) == -1)
	    fatal("In main() writing to file.");
	write(file_des
	, "\n", 1);
		
	/* Close the file. */
	if (close(file_des) == -1)
	    fatal("In main() closing the file.");
	
	printf("Note has been saved.\n");
	
	return 0;
}

