#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <fcntl.h>
#include <sys/stat.h>

void usage(char *, char *);
void fatal(char *);
void *errorchecked_malloc(unsigned int);
void safer_free(void **);


int main(int argc, char **argv)
{
	int file_des;
	char *buffer, *datafile;
	
	/* Allocate memory for the strings. */
	buffer = (char *) errorchecked_malloc(100);
	datafile = (char *) errorchecked_malloc(20);
	
	/* Add in filepath of the file folder. */
	strcpy(datafile, "/tmp/notes");
	
	/* Check that enough arguments have been given. */
	if (argc < 2) 
	    usage(argv[0], datafile);
	
	/* Copy the argument into memory. */
	strcpy(buffer, argv[1]);
	printf("[DEBUG] buffer @ %p: `%s`\n", buffer, buffer);
	printf("[DEBUG] buffer @ %p: `%s`\n", datafile, datafile);
	strncat(buffer, "\n", 1);
	
	/* Open the file. */
	file_des = open(datafile, O_WRONLY|O_CREAT|O_APPEND, S_IRUSR|S_IWUSR);
	
	if (file_des == -1)
	    fatal("In main() trying to open a file.");
	
	printf("[DEBUG] file descriptor is %d.\n", file_des);
	
	/* Write data to the file. */
	if (write(file_des, buffer, strlen(buffer)) == -1)
	    fatal("In main() writing to file.");
	
	/* Close the file. */
	if (close(file_des) == -1)
	    fatal("In main() closing the file.");
	
	printf("Note has been saved.\n");
	
	return 0;
}


void usage(char *prog_name, char *filename) {
    
    printf("Usage: %s <data to add to %s>\n\n", prog_name, filename);
    exit(0);
}

void fatal(char *msg) {
    /* Display an error message and exit the program. */

    char error_msg[100];
    
    strcpy(error_msg, "[!!] Fatal Error: ");
    strncat(error_msg, msg, 84);
    perror(error_msg);
    exit(-1);
}

void *errorchecked_malloc(unsigned int size) {

    void *new_mem_addr;
    
    printf("\t[+] allocating %u bytes of memory.\n", size);
    
    /* Allocate the memory */
    new_mem_addr = malloc(size);
    
    /* Check that the allocation worked. */
    if (new_mem_addr == NULL) {
        fprintf(stderr, "Error: Memory could not be allocated!");
        exit(-1);
    }
    
    printf("\t[+] Memory located at address %p.\n\n", new_mem_addr);
    
    return new_mem_addr;
}

void safer_free(void **mem_address) {

    if (mem_address == NULL)
        printf("\t[-] pointer at %p is already NULL.\n", mem_address);
    
    else {
        printf("\t[-] freeing pointer at %p.\n", mem_address);
        free(*mem_address);
    }
}

