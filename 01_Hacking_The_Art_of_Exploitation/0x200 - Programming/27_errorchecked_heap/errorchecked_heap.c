#include <stdio.h>
#include <stdlib.h>
#include <string.h>

void *errorchecked_malloc(unsigned int size);
void *safer_free(void *mem_address);

int main(int argc, char **argv)
{
	char *char_ptr;
	int *int_ptr;
	int mem_size;
	
	/* If the memsize has not been given, set it. */
	if (argc < 2)
	    mem_size = 50;
	else
	    mem_size = atoi(argv[1]);
	
	/* Allocate a string on the heap. */
	char_ptr = (char *) errorchecked_malloc(mem_size);
	strcpy(char_ptr, "This is located on the heap.");
	printf("char_ptr (%p) -> `%s`\n", char_ptr, char_ptr);
	
	/* Allocate a int on the heap. */
	int_ptr = (int *) errorchecked_malloc(15);
	*int_ptr = 31337;
	printf("int_ptr(%p) -> `%d`\n", int_ptr, *int_ptr);	
	
	/* Allocating another string on the heap. */
	char_ptr = safer_free(char_ptr);
	char_ptr = (char *) errorchecked_malloc(mem_size);
	strcpy(char_ptr, "This is also located on the heap.");
	printf("char_ptr (%p) -> `%s`\n", char_ptr, char_ptr);
	
	char_ptr = safer_free(char_ptr);
	int_ptr = safer_free(int_ptr);

	return 0;
}

void *errorchecked_malloc(unsigned int size) {

    void *new_mem_addr;
    
    printf("\t[+] allocating %u bytes of memory.\n", size);
    
    /* Allocate the memory */
    new_mem_addr = malloc(size);
    
    /* Check that the allocation worked. */
    if (new_mem_addr == NULL) {
        fprintf(stderr, "Error: Memory could not be allocated!");
        exit(-1);
    }
    
    printf("\t[+] Memory located at address %p.\n\n", new_mem_addr);
    
    return new_mem_addr;
}

void *safer_free(void *mem_address) {

    if (mem_address == NULL)
        printf("\t[-] pointer at %p is already NULL.\n", mem_address);
    
    else {
        printf("\t[-] freeing pointer at %p.\n", mem_address);
        free(mem_address);
    }
    
    /* Set the point address to NULL. */
    return NULL;
}

