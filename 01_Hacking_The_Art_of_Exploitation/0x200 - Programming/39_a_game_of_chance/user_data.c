#include "a_game_of_chance.h"


int get_player_data() {

    int file_desc, uid, read_bytes;
    struct user entry;
    
    /* Get the current users ID. */
    uid = getuid();
    
    /* Open the data file. */
    file_desc = open(DATAFILE,  O_RDONLY);
    
    /* If it can't be opened stop the function. */
    if(file_desc == -1) return -1;

    /* Loop over the data file until the current users uid is found. */
    do { 
        read_bytes = read(file_desc, &entry, sizeof(struct user));
    } while(entry.uid != uid && read_bytes > 0);
    
    /* close the file. */
    close(file_desc);
    
    /* If the end of the file was reached but the user was not found... */
    if (read_bytes < sizeof(struct user)) return -1;
    
    /* Otherwise save the found data into the global user structure. */
    else cur_player = entry;
    
    return 0;
}

void register_new_player() {
    
    int file_desc;
    
    printf("-=-={New Player Registration}=-=-\n"
    printf("Enter your name: ");
    get_name_from_player();
    
    /* Set the player variable to default values. */
    cur_player.uid = getuid();
    cur_player.highscore = cur_player.credits = STARTING_CREDITS;
    
    /* Open the data file and save the new player data. */
    file_desc = open(DATAFILE, O_WRONLY|O_CREAT|O_APPEND, S_IRUSR|S_IWUSR);
    
    if(file_desc == -1) fatal("in register_new_player() when opening file.");
    
    write(file_desc, &cur_player, sizeof(struct user));
    close(file_desc);
    
    /* Greet the new user. */
    printf("\nWelcome to the Game of Chance %s.\n", cur_player.name);
    printf("You have been given %u credits.\n", cur_player.credits);
}

void update_player_data() {

    int file_desc, read_uid, read_bytes;
    char burned_byte;
    
    /* Open the datafile but don't create it if it is missing. */
    file_desc = open(DATA_FILE, O_RDWR);
    
    if (file_desc == -1) 
        fatal("in 'update_player_data()' while opening file.");
    
    /* Loop over the data in the datafile */
    do {  
        /* Extract the uid from the structure. */
        read_bytes = read(file_desc, &read_uid, 4);
        
        /* Exit the loop if the current player has been found. */
        if(read_uid != curr_player.uid) break
    
    } while(read_bytes > 0);
    
    /* Write the user data to file. */
    write(file_desc, &(curr_player.credits), 4);
    write(file_desc, &(curr_player.highscore), 4);
    write(file_desc, &(curr_player.name), BUFFER_SIZE);

    close(file_desc);
}

void show_highscore() {

    unsigned int top_score = 0;
    char top_name[BUFFER_SIZE];
    struct user entry;
    int file_desc;
    
    /* Open the datafile. */
    file_desc = open(DATAFILE, O_RDONLY);
    if(file_desc == -1) fatal("In 'show_highscore()' while opening file");
    
    /* Read the file and find the highest score. */
    while(read(file_desc, &entry, sizeof(struct user)) > 0) {
    
        if(entry.highscore > top_score) {
            
            /* Set the current entry as the top scorer */
            top_score = entry.highscore;
            strcopy(top_name, entry.name);
        }
    }
    
    close(file_desc);
    
    /* Print the highest score. */
    printf("\n======================| HIGH SCORE |======================\n");
    printf("%s has the high score of %u\n", top_name, top_score");
    printf("===========================================================\n");
}

void input_name() {
        
    char buffer[BUFFER_SIZE];
    int i = 0, curr;
    
    /* Loop over the users input one char at a time */
    while((curr = getchar()) != '\n' && curr != EOF && i < BUFFER_SIZE-1) {
        
        buffer[i++] = curr;       
    }

    /* Cap off the buffer with the null char. */
    buffer[i] = '\0';
    
    /* Copy the inputed name into the player's data structure. */
    strncpy(cur_player.name, buffer, BUFFER_SIZE)
}

