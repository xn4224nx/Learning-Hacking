#include "a_game_of_chance.h"


void jackpot(int credits) {

    printf("-=-=-=-=-=-{JACKPOT}-=-=-=-=-=-\n");
    printf("You have won the jackpot of %d.\n", credits);
    cur_player.credits += credits;
}

void print_cards(char *message, char *cards, int user_pick) {
    
    /* Print the message and the cards. */
    printf("\n\t*** %s ***\n", message);
    printf("      \t._.\t._.\t._.\n");
    printf("Cards:\t|%c|\t|%c|\t|%c|\n\t", cards[0], cards[1], cards[2]);
    
    /* Print what the user chose or the viable options. */
    if(user_pick == -1) 
        printf(" 1 \t 2 \t 3\n");
    else {
    
        for(int i=0; i < user_pick; i++)
            printf("\t");
        printf(" ^-- your pick\n");
    }
}

int take_wager(int avail_credits, int prev_wager) {

    int wager, total_wager;
    
    /* Take the wager ammount from the user. */
    printf("How many credits of your %d credits would you like to wager? ", 
        avail_credits);
    scanf("%d", &wager);
    
    /* Ensure the wager is +ve. */
    if(wager < 1) {
        printf("Wager must be greater than 0.");
        return -1;
    }
    
    /* Confirm the user has the required credit. */
    total_wager = prev_wager + wager;
    if(total_wager > avail_credits) {
    
        printf("Your total wager of %d is more than you have.\n", total_wager);
        printf("You only have %d credits.\n", avail_credits);
        return -1;
    }
    
    return wager;
}

void play_the_game() {

    int play_again = 1;
    int(*game) ();
    char selection;
    
    while(play_again) {
    
        if(DEBUG_MSG)
            printf("\n[DEBUG] current game pointer @ 0x%08x\n", 
                cur_player.current_game);
        
        /* If the game plays without error. */
        if(cur_player.current_game()) {
        
            /* Set a new high score. */
            if(cur_player.credits > cur_player.highscore)
                cur_player.highscore = cur_player.credits;
                
            printf("You now have %d credits.", cur_player.credits);
            update_player_data();
            
            /* Find out if the user wants to play again. */
            printf("Would you like to play again? (y/n) ");
            selection = '\n';
            
            while(selection == '\n')
                scanf("%c", &selection);
            
            if(selection == 'n') play_again = 0;
        }
        /* Stop the loop after a game error. */
        else
            play_again = 0;
    }
}

int pick_a_number() {

    int pick, winning_number;
    
    printf("\n####### Pick a Number #######\n");
    printf("This game costs 10 credits to play. Simply pick a number\n");
    printf("between one and twenty. If you guess correctly, you will\n");
    printf("win a jackpot of one hundred credits!!\n\n");
    
    /* Generate the number that the user needs to guess. */
    winning_number  = (random() % 20) + 1;
    
    /* Check the user has enough credits to play. */
    if(cur_player.credits < 10) {
        printf("You only have %d credits, that is not enough to play!\n\n",
            cur_player.credits);
        return -1;
    }
    
    cur_player.credits -= 10;
    printf("10 credits have been deducted from your account.\n");
    
    printf("Pick a number between 1 and 20: ");
    scanf("%d", &pick);
    
    if(pick == winning_number) 
        jackpot(100);
    else
        printf("Sorry you didn't win.\n");
    
    return 0;    
}

int dealer_no_match() {

    int i, j, numbers[16], match, wager = -1;
    
    printf("\n::::::: No Match Dealer :::::::\n");
    printf("In this game, you can wager up to all of your credits.\n");
    printf("The dealer will deal out 16 random numbers between 0\n");
    printf("and 99. If there are no duplicates amoungst the\n");
    printf("picked numbers you double you credits.\n\n");
    
    /* Check the user has enough credits to play. */
    if(cur_player.credits < 1) {
        printf("You don't have any credits to wager!\n\n");
        return -1;
    }
    
    /* Get the players wager. */
    while(wager == -1)
        wager = take_wager(cur_player.credits, 0);
    
    /* Generate the numbers. */
    for(i = 0; i < 16; i++) {
    
        numbers[i] = random() % 100;
        printf("%2d\t", numbers[i]);
        
        /* Print a line break every 8 numbers */
        if(i%8 == 7)
            printf("\n");
    }
    
    /* Check for duplicates in the generated numbers. */
    match = check_for_dupes(numbers, 16);
    
    if(match != -1) {
        printf("The dealer matched the numbers %d!\n", match);
        printf("You loose %d credits!\n\n", wager);
        cur_player.credits -= wager;
    } else {
        printf("There were no matches! You win %d credits!\n\n", wager);
        cur_player.credits += wager;
    }
    
    return 0;
}

int check_for_dupes(int *num_arr, int arr_len) {

    /* Iterate over all combinations */
    for(int i=0; i < arr_len-1; i++) {
        for(int j=i+1; j < arr_len; j++) {
            
            /* Compare each element to the other */
            if(num_arr[i] == num_arr[j])
                return num_arr[i];
        }
    }
    return -1;
}

int find_the_ace() {

    int ace, total_wager, invalid_choice, i;
    int pick = -1, wager_1 = -1, wager_2 = -1;
    char choice_2, cards[3] = {'X', 'X', 'X'};
    
    /* Place the ace. */
    ace = random() % 3;
    
    printf("******* Find the Ace *******\n");
    printf("In this game, you can wager up to all of your credits.\n");
    printf("Three cards will be dealt out, two queens and one ace.\n");
    printf("If you find the ace, you will win your wager.\n");
    printf("After choosing a card, one of the queens will be revealed.\n");
    printf("At this point, you may either select a different card or\n");
    printf("increase your wager.\n\n");
    
    /* Check the user has enough credits to play. */
    if(cur_player.credits < 1) {
        printf("You don't have any credits to wager!\n\n");
        return -1;
    }
    
    /* Get the users wager. */
    while(wager_1 == -1)
        wager_1 = take_wager(cur_player.credits, 0);
    
    /* Play the game. */
    print_cards("Dealing cards", cards, -1);
    
    while((pick < 1) || (pick > 3)) {
    
        /* Get the users guess. */
        printf("Select a card: 1, 2 or 3 ");
        scanf("%d", &pick);
    }
    pick--;
    
    /* Show the card that is not an ace or the users choice. */
    for(i = 0; i == ace || i == pick; i++) {}
    cards[i] = 'Q';
    print_cards("Revealing a queen", cards, pick);
    
    /* Find out if the user wants to change their pick. */
    invalid_choice = 1;
    while(invalid_choice) {
    
        printf("Would you like to:\n");
        printf("[c]hange your pick\tor\t[i]ncrease your wager?\n");
        
        choice_2 = '\n';
        
        while(choice_2 == '\n')
            scanf("%c", &choice_2);
        
        if(choice_2 == 'c') {
            invalid_choice = 0;
            
            for(i=0; i==ace || i==pick; i++) {}
            pick = i;
            printf("You card has been changed to %d\n", pick+1);
               
        } else if(choice_2 == 'i') {
            invalid_choice = 0;
            
            /* Get a valid wager. */
            while(wager_2 == -1)
                wager_2 = take_wager(cur_player.credits, wager_1);
        }
    }
    
    /* Show all the cards. */
    for(i=0; i < 3; i++) {
        if (ace == i)
            cards[i] = 'A';
        else
            cards[i] = 'Q';        
    }
    print_cards("End results", cards, pick);
    
    /* Handle a win */
    if(pick == ace) {
        printf("You have won %d credits from the first wager\n", wager_1);
        cur_player.credits += wager_1;
        
        if(wager_2 != -1) {
            printf("You have won %d credits from the second wager\n", wager_2);
            cur_player.credits += wager_2;
        }
    
    } else {
        printf("You have lost %d credits from the first wager\n", wager_1);
        cur_player.credits -= wager_1;
        
        if(wager_2 != -1) {
            printf("You have lost %d credits from the second wager\n", wager_2);
            cur_player.credits -= wager_2;
        }
    }
    return 0;
}

